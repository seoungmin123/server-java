
## 주요 기능 요약 (요구사항/제약사항)

- **포인트 충전/조회/사용**
    - 사용자 포인트를 충전하고 현재 잔액 및 충전/사용 이력을 조회할 수 있습니다.
    - 포인트 사용 시 `Optimistic Lock`을 적용해 중복 차감을 방지합니다.

- **상품 조회**
    - 전체 상품 목록 및 개별 상품 상세 정보를 조회할 수 있습니다.
    - 단일 옵션 상품만 제공하며 페이징은 지원하지 않습니다.

- **쿠폰 발급 및 사용**
    - 선착순으로 쿠폰을 발급받을 수 있으며, 보유 쿠폰 목록과 사용 가능 여부를 확인할 수 있습니다.
    - 쿠폰 중복 발급, 만료, 타인 쿠폰 사용은 제한됩니다.

- **주문 및 결제**
    - 사용자는 여러 상품을 선택하여 주문하고 충전된 포인트로 결제할 수 있습니다.
    - 주문 시 상품 재고를 확인하고 차감하며, `Pessimistic Lock`을 적용해 동시 주문 시 재고 초과 방지를 보장합니다.
    - 쿠폰 적용 시 할인 금액이 반영되며, 외부 데이터 플랫폼으로 주문 내역을 전송합니다 (Mock 처리).

- **주문 조회**
    - 전체 주문 내역 및 단건 주문 상세 정보, 결제 내역을 조회할 수 있습니다.
    - 주문 완료 후 외부 시스템으로 주문 내역을 전송합니다.

- **동시성 및 제약사항 처리**
    - 잔액 부족, 재고 부족, 쿠폰 무효 등의 상황에 대한 예외 처리를 포함합니다.
    - 멀티 인스턴스 환경 및 동시 요청에도 일관성 있게 동작하도록 설계되었습니다.



## 기능 요구사항

| 기능명        | 설명                        | 입력값                                     | 처리 과정                                                               | 출력값                                        | 예외/제약사항                                    |
|------------| ------------------------- | --------------------------------------- | ------------------------------------------------------------------- |--------------------------------------------|--------------------------------------------|
| 포인트 이력 조회  | 충전/사용 내역을 조회 (돈 흐름 확인 목적) | userId                                  | 이력 테이블에서 사용자 기준 조회                                                  | 이력테이블리스트(amount, balanceAfter, type, 일시..) | 사용자 없을시 예외 , 최신순 조회                        |
| 포인트 조회     | 사용자 잔액 조회                 | userId                                  | 사용자 잔액 조회                                                           | 사용자 객체(userId, point..)                    | 사용자 없을시 예외                                 |
| 포인트 충전     | 사용자 잔액 증가 및 충전 이력 저장      | userId, point                          | 잔액 증가 → 충전 이력 기록                                                    | 충전 후 잔액을 포함한 사용자 객체                        | 음수/0원 충전 불가                                |
| 포인트 사용     | 잔액 차감 및 사용 이력 저장          | userId, point                          | 잔액 확인 → 차감 → 사용 이력 기록                                               | 사용 후 잔액을 포함한 사용자 객체                        | 잔액 부족 시 실패                                 |
| 상품 전체 조회   | 모든 상품 목록 조회               | 없음                                      | 상품 테이블에서 전체 조회                                                      | 상품 리스트                                     | 페이징 없음, 상품 단일 옵션만 제공                       |
| 상품 상세 조회   | 특정 상품 상세 정보 조회            | 상품 ID                                   | 상품 존재 여부 확인 → 정보 조회                                                 | 상품 ID, 상품명, 가격, 잔여수량                       | 상품 없을 시 예외, 단일 옵션                          |
| 인기상품 조회    | 최근 3일간 가장 많이 팔린 상위 상품 조회  | 몇개자를지 , 날짜                                      | 주문 상세 기준 판매 이력 집계 → 정렬                                              | 상위 5개 상품 리스트  (총판매갯수 포함)                   | 최근 3일 내 판매 없으면 빈 리스트 반환                    |
| 쿠폰 발급      | 선착순 할인 쿠폰 발급              | userId                                  | 수량 확인 → 중복 발급 여부 확인 → 쿠폰 저장                                         | 발급 성공 여부,쿠폰 정보(쿠폰명,발급일시 등)                 | 수량 부족, 중복 발급 불가 ,동일쿠폰정책은 사용자1인1매           |
| 쿠폰사용가능조회   | 쿠폰 사용 가능 여부 사전 검증         | userId, couponId                        | 쿠폰 만료 여부 확인 → 사용자 보유 및 사용 여부 확인                                     | 사용 가능 여부 (`true/false`)                    | 쿠폰 만료, 이미 사용, 사용자 소유 아님 등                  |
| 보유쿠폰조회     | 보유 중인 쿠폰 목록 조회            | userId                                  | 사용자 기준 쿠폰 목록 조회                                                     | 쿠폰 목록                                      | 없음                                         |
| 주문 요청      | 상품 주문 및 결제 처리             | userId, 상품 리스트(상품ID, 수량), couponId (선택) | 상품 존재 확인 → 재고 확인/차감 → 쿠폰 할인 적용 → 잔액 확인/차감 → 주문 저장 → 외부 시스템 연동(Mock) | 결제 결과                                      | 재고 부족, 잔액 부족, 쿠폰 만료, 여러 상품 주문 가능, 충전 잔액 사용 |
| 주문 내역 조회   | 사용자의 전체 주문 목록 조회          | userId                                  | 사용자 기준 주문 + 주문 상세 조회                                                | 주문일시, 주문상태, 총금액                            | 주문 없을 경우 빈 리스트 반환                          |
| 주문 상세 조회   | 단일 주문 상세 항목 조회            | orderId                                 | 주문 존재 여부 확인 → 주문 상세 항목 조회                                           | 상품ID, 수량, 주문가격, 주문상태, 주문일시                 | 주문 ID 유효하지 않을 시 예외                         |
| 주문 결제내역 조회 | 단일 주문에 대한 결제 정보 조회        | orderId                                 | 주문 존재 여부 확인 → 결제 내역 조회                                              | 상품ID, 쿠폰ID, 총금액, 할인금액, 실제 결제금액, 결제일시       | 주문 ID 유효하지 않을 시 예외, 부분취소/결제취소 불가           |
| 외부 시스템 주문 전달         | 주문 완료 후 외부 시스템으로 주문 내역 전송        | orderId, 주문 정보                                 | 주문 저장 완료 후 외부 API(POST /external/orders) 호출                                            | API 호출 성공 여부 `(success, message, status)`  | 외부시스템 실패시 예외처리                             |

## 비기능 요구사항
- 동시성 Pessimistic Lock (상품), Optimistic Lock (@Version) (포인트) 적용
- 확장포인트 : 인터페이스 기반 설계 

- 동시성 제어
  - 상품 재고 차감에는 Pessimistic Lock 적용
  - 포인트 차감에는 Optimistic Lock(@Version) 적용

- 확장성 및 유지보수성
  - 인터페이스 기반 설계로 추후 외부 API 연동 방식 변경 시 영향 최소화 예정

- 외부 시스템 연동 처리
  - 주문 완료 후 외부 시스템으로 주문 정보 전달
